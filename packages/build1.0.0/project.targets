<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="4.0" DefaultTargets="$(DefaultTarget)">

  <Import Project="base.targets"/>

  <PropertyGroup>
    <NuGetDir>$(MSBuildThisFileDirectory)..\NuGet.1.2</NuGetDir>
  </PropertyGroup>

  <ItemGroup Condition="@(BuildProfile)==''">
    <BuildProfile Include="Default">
      <Properties>TargetClrVersion=2.0</Properties>
      <OutputPath></OutputPath>
    </BuildProfile>
  </ItemGroup>
  
  <Target Name="Clean" DependsOnTargets="$(CleanDependsOn);_CleanProject;_CleanNuGetPackage">
    
  </Target>

  <Target Name="Build" DependsOnTargets="$(BuildDependsOn);_BuildWithProfile;_CopyAssembliesToNuGetStaging;">
    
  </Target>

  <Target Name="Package" DependsOnTargets="$(PackageDependsOn);_CreateNuGetPackage">
    
  </Target>
  
  <Target Name="Export" DependsOnTargets="$(ExportDependsOn);_ExportNuGetPackage">
  </Target>

  <Target Name="_CleanProject">
    <MSBuild Projects="@(Project)" Targets="Clean" Properties="$(Properties)" />
  </Target>

  <Target Name="_CleanNuGetPackage">
    <ItemGroup>
      <NuGetPackage Include="$(MSBuildProjectDirectory)\*.nupkg" />
    </ItemGroup>  
    <Delete Files="@(NuGetPackage)"  />
  </Target>

  <Target Name="_BuildWithProfile">
    <PropertyGroup>
      <ProjectPath>%(Project.FullPath)</ProjectPath>
    </PropertyGroup>
    <MSBuild Projects="$(ProjectPath)" Targets="Rebuild" Properties="$(Properties);%(BuildProfile.Properties)" />
  </Target>

  <Target Name="_CopyAssembliesToNuGetStaging">
    <PropertyGroup>
      <AssemblyName>%(ExportAssembly.Identity)</AssemblyName>
    </PropertyGroup>
    <ItemGroup>
      <PackageAssembly Include="bin\$(Configuration)\%(BuildProfile.OutputPath)\$(AssemblyName).dll">
        <NuGetStagingFolder>$(MSBuildProjectDirectory)\NuGet\lib\%(BuildProfile.OutputPath)</NuGetStagingFolder>
      </PackageAssembly>
      <PackageAssembly Include="bin\$(Configuration)\%(BuildProfile.OutputPath)\$(AssemblyName).pdb">
        <NuGetStagingFolder>$(MSBuildProjectDirectory)\NuGet\lib\%(BuildProfile.OutputPath)</NuGetStagingFolder>
      </PackageAssembly>
      <PackageAssembly Include="bin\$(Configuration)\%(BuildProfile.OutputPath)\$(AssemblyName).xml"
                       Condition="Exists('bin\$(Configuration)\%(BuildProfile.OutputPath)\$(AssemblyName).xml')">
        <NuGetStagingFolder>$(MSBuildProjectDirectory)\NuGet\lib\%(BuildProfile.OutputPath)</NuGetStagingFolder>
      </PackageAssembly>
    </ItemGroup>
    <Copy SourceFiles="@(PackageAssembly)" DestinationFolder="%(PackageAssembly.NuGetStagingFolder)" Condition="Exists('$(MSBuildProjectDirectory)\NuGet')" />
  </Target>

  <Target Name="_CreateNuGetPackage">
    <ItemGroup>
      <NuGetSpec Include="$(MSBuildProjectDirectory)\*.nuspec" />
    </ItemGroup>
    
    <Exec Command="$(NuGetDir)\NuGet.exe pack &quot;%(NuGetSpec.FullPath)&quot; -o &quot;$(MSBuildProjectDirectory)\NuGet&quot;"
          WorkingDirectory="$(MSBuildProjectDirectory)"
          LogStandardErrorAsError="true" />
  </Target>

  <Target Name="_ExportNuGetPackage">
    <Message Text="ExportDir is $(ExportDir)" />
    <ItemGroup>
      <NuGetPackage Include="$(MSBuildProjectDirectory)\NuGet\*.nupkg" />
    </ItemGroup>
    <Copy SourceFiles="@(NuGetPackage)" DestinationFolder="$(ExportDir)" />
  </Target>
  
</Project>
